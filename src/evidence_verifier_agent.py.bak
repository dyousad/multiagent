"""Evidence verifier agent for validating retrieved evidence."""

from __future__ import annotations

from typing import Any, Dict, List, Optional

from llm_agent import LLMAgent


class EvidenceVerifierAgent(LLMAgent):
    """Agent specialized in verifying evidence quality and relevance.

    This agent:
    - Verifies whether retrieved evidence contains key entities or facts
    - Checks for keyword/entity overlap between question and evidence
    - Can trigger rewriting of sub-questions if verification fails
    - Uses LLM to generate revised questions for better retrieval
    """

    def __init__(
        self,
        agent_id: str = "verifier",
        model_identifier: str = "deepseek-ai/DeepSeek-V3",
        max_tokens: int = 256,
        temperature: float = 0.7,
        min_keyword_match_ratio: float = 0.5,
    ):
        """Initialize the evidence verifier agent.

        Parameters
        ----------
        agent_id : str
            Unique identifier for this agent.
        model_identifier : str
            Model identifier for API.
        max_tokens : int
            Maximum tokens for LLM generation.
        temperature : float
            Sampling temperature for LLM.
        min_keyword_match_ratio : float
            Minimum ratio of keywords that must be found in evidence.
        """
        system_prompt = """You are an evidence verification specialist. Your task is to analyze whether retrieved evidence is relevant to a question.

When given a question and evidence passages:
1. Identify key entities, facts, and keywords in the question
2. Check if these appear in the evidence
3. If evidence seems insufficient or irrelevant, rewrite the question to improve retrieval

When rewriting questions:
- Make them more specific and concrete
- Add context or clarifying details
- Rephrase to target the missing information
- Keep the core intent of the original question

Example:
Original: "What is the capital?"
Rewritten: "What is the capital city of the country mentioned in the previous context?"

Original: "Who directed it?"
Rewritten: "Who was the director of the movie mentioned in the question?"
"""

        super().__init__(
            agent_id=agent_id,
            model_identifier=model_identifier,
            role="evidence_verifier",
            system_prompt=system_prompt,
            max_tokens=max_tokens,
            temperature=temperature,
        )

        self.min_keyword_match_ratio = min_keyword_match_ratio

    def act(self, observation: Dict[str, Any]) -> str:
        """Verify evidence quality and suggest improvements.

        Parameters
        ----------
        observation : Dict[str, Any]
            Must contain:
            - 'sub_question' or 'question': The question
            - 'evidence': List of evidence passages

        Returns
        -------
        str
            Verification result and possibly revised question.
        """
        # Extract question and evidence
        question = observation.get("sub_question") or observation.get("question", "")
        evidence = observation.get("evidence", [])

        if not question:
            return "Error: No question provided"

        if not evidence:
            return self._generate_revised_question(question, "No evidence retrieved")

        # Verify evidence
        result = self.verify_evidence(question, evidence)

        # Record contribution
        status = "verified" if result["verified"] else "needs revision"
        self.record_contribution(f"Evidence {status} for question")

        # Format output
        if result["verified"]:
            return f"Evidence verified successfully. Found {result['matched_keywords']} matching keywords."
        else:
            return (
                f"Evidence verification failed. "
                f"Only {result['matched_keywords']}/{result['total_keywords']} keywords matched.\n"
                f"Revised question: {result.get('revised_question', question)}"
            )

    def verify_evidence(
        self, question: str, evidence: List[str]
    ) -> Dict[str, Any]:
        """Verify if evidence is relevant to the question.

        Parameters
        ----------
        question : str
            The question.
        evidence : List[str]
            List of evidence passages.

        Returns
        -------
        Dict[str, Any]
            Verification result containing:
            - 'verified': bool
            - 'matched_keywords': int
            - 'total_keywords': int
            - 'revised_question': str (if not verified)
        """
        # Extract keywords (capitalized words and longer words)
        keywords = self._extract_keywords(question)

        # Check keyword presence in evidence
        evidence_text = " ".join(evidence).lower()
        matched = sum(1 for keyword in keywords if keyword.lower() in evidence_text)

        total = len(keywords)
        verified = total == 0 or (matched / total) >= self.min_keyword_match_ratio

        result = {
            "verified": verified,
            "matched_keywords": matched,
            "total_keywords": total,
        }

        # Generate revised question if not verified
        if not verified:
            revised = self._generate_revised_question(
                question, f"Only {matched}/{total} keywords found in evidence"
            )
            result["revised_question"] = revised

        return result

    def _extract_keywords(self, question: str) -> List[str]:
        """Extract important keywords from a question.

        Parameters
        ----------
        question : str
            The question text.

        Returns
        -------
        List[str]
            List of keywords.
        """
        keywords = []

        # Extract capitalized words (likely entities)
        words = question.split()
        for word in words:
            # Remove punctuation
            cleaned = word.strip(".,?!:;\"'")
            # Keep if starts with capital or is long enough
            if cleaned and (cleaned[0].isupper() or len(cleaned) > 5):
                keywords.append(cleaned)

        return keywords

    def _generate_revised_question(self, question: str, reason: str) -> str:
        """Generate a revised question using LLM.

        Parameters
        ----------
        question : str
            Original question.
        reason : str
            Reason for revision.

        Returns
        -------
        str
            Revised question.
        """
        # Build prompt for LLM
        observation = {
            "task": (
                f"Rewrite or expand the following question to improve evidence retrieval.\n"
                f"Original question: {question}\n"
                f"Reason for revision: {reason}\n"
                f"Provide only the revised question, without explanation."
            )
        }

        # Generate revised question
        revised = super().act(observation)

        # Clean up response
        revised = revised.strip()

        # Remove common prefixes if present
        prefixes = ["Revised question:", "New question:", "Question:"]
        for prefix in prefixes:
            if revised.startswith(prefix):
                revised = revised[len(prefix) :].strip()

        return revised

    def verify_with_rewrite(
        self, question: str, evidence: List[str], max_retries: int = 1
    ) -> Dict[str, Any]:
        """Verify evidence and rewrite question if needed.

        Parameters
        ----------
        question : str
            Original question.
        evidence : List[str]
            Evidence passages.
        max_retries : int
            Maximum number of question rewrites to attempt.

        Returns
        -------
        Dict[str, Any]
            Result containing:
            - 'verified': bool
            - 'final_question': str
            - 'rewrites': int
            - 'verification_details': Dict
        """
        current_question = question
        rewrites = 0

        for attempt in range(max_retries + 1):
            # Verify evidence
            result = self.verify_evidence(current_question, evidence)

            if result["verified"] or attempt == max_retries:
                return {
                    "verified": result["verified"],
                    "final_question": current_question,
                    "rewrites": rewrites,
                    "verification_details": result,
                }

            # Rewrite question for next attempt
            current_question = result.get("revised_question", current_question)
            rewrites += 1

        return {
            "verified": False,
            "final_question": current_question,
            "rewrites": rewrites,
            "verification_details": {},
        }
